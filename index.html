<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FLAG ARENA</title>
<style>
body{margin:0;background:white;overflow:hidden;font-family:Arial;}
canvas{display:block;}
#winsBoard{position:absolute;top:20px;right:20px;width:230px;font-size:13px;}
.winItem{display:flex;align-items:center;margin-bottom:4px;}
.winItem img{width:18px;height:12px;margin-right:6px;}
#countdown{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:80px;font-weight:bold;}
</style>
</head>
<body>

<div id="countdown"></div>

<div id="winsBoard">
<h3>Top Wins</h3>
<div id="winsList"></div>
</div>

<canvas id="game"></canvas>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;

const centerX=canvas.width/2;
const centerY=canvas.height/2-40;

const outerRadius=260;
const wallThickness=20;
const innerRadius=outerRadius-wallThickness;

const gapSize=Math.PI/8;

let gapAngle=0;
let flags=[];
let eliminated=[];
let wins={};
let active=false;

const codes=[
"tr","us","de","fr","br","jp","it","es","gb","ca",
"ru","cn","in","ar","mx","nl","se","no","fi","pl",
"pt","gr","ch","be","at","dk","kr","au","nz","za",
"sa","ae","ir","iq","eg","cl","co","ve","pe","cz",
"hu","ro","sk","si","hr","bg","ua","kz","th","my",
"id","ph","sg","pk","bd","ng","ke","ma","tn","dz"
];

function loadFlags(){
flags=[];
codes.forEach(c=>{
let img=new Image();
img.src=`https://flagcdn.com/w80/${c}.png`;
flags.push({
img:img,
name:img.src,
x:centerX+(Math.random()-0.5)*100,
y:centerY+(Math.random()-0.5)*100,
vx:(Math.random()-0.5)*3,
vy:(Math.random()-0.5)*3,
r:16
});
});
}

function countdown(){
let c=3;
let el=document.getElementById("countdown");
el.innerText=c;
let i=setInterval(()=>{
c--;
if(c>=0) el.innerText=c;
if(c<0){clearInterval(i);el.innerText="";active=true;}
},1000);
}

function collide(a,b){
let dx=b.x-a.x;
let dy=b.y-a.y;
let d=Math.sqrt(dx*dx+dy*dy);
if(d<a.r+b.r){
let nx=dx/d;
let ny=dy/d;
let o=(a.r+b.r-d)/2;
a.x-=nx*o;
a.y-=ny*o;
b.x+=nx*o;
b.y+=ny*o;
[a.vx,b.vx]=[b.vx,a.vx];
[a.vy,b.vy]=[b.vy,a.vy];
}
}

function drawWall(){
ctx.fillStyle="black";
ctx.beginPath();
ctx.arc(centerX,centerY,outerRadius,0,Math.PI*2);
ctx.arc(centerX,centerY,innerRadius,0,Math.PI*2,true);
ctx.fill();

ctx.globalCompositeOperation="destination-out";
ctx.beginPath();
ctx.moveTo(centerX,centerY);
ctx.arc(centerX,centerY,outerRadius,gapAngle,gapAngle+gapSize);
ctx.closePath();
ctx.fill();
ctx.globalCompositeOperation="source-over";
}

function update(){
ctx.clearRect(0,0,canvas.width,canvas.height);

gapAngle+=0.02;

drawWall();

if(active){

for(let i=0;i<flags.length;i++)
for(let j=i+1;j<flags.length;j++)
collide(flags[i],flags[j]);

flags.forEach(f=>{

let oldX=f.x;
let oldY=f.y;

let newX=f.x+f.vx;
let newY=f.y+f.vy;

let dx=newX-centerX;
let dy=newY-centerY;
let newDist=Math.sqrt(dx*dx+dy*dy);

let angle=Math.atan2(dy,dx);
let rel=(angle-gapAngle+Math.PI*2)%(Math.PI*2);

if(newDist+f.r>innerRadius){

if(rel<gapSize){
f.x=newX;
f.y=newY;
eliminated.push(f);
return;
}

let oldDX=oldX-centerX;
let oldDY=oldY-centerY;
let oldDist=Math.sqrt(oldDX*oldDX+oldDY*oldDY);

let nx=oldDX/oldDist;
let ny=oldDY/oldDist;

f.x=centerX+nx*(innerRadius-f.r);
f.y=centerY+ny*(innerRadius-f.r);

let dot=f.vx*nx+f.vy*ny;

f.vx=f.vx-2*dot*nx;
f.vy=f.vy-2*dot*ny;

}else{
f.x=newX;
f.y=newY;
}

});

flags=flags.filter(f=>!eliminated.includes(f));

if(flags.length===1){
let w=flags[0];
wins[w.name]=(wins[w.name]||0)+1;
updateWins();
active=false;
setTimeout(reset,2500);
}
}

flags.forEach(f=>{
ctx.drawImage(f.img,f.x-f.r,f.y-f.r,f.r*2,f.r*2);
});

eliminated.forEach((f,i)=>{
ctx.drawImage(f.img,20+i*22,canvas.height-50,20,14);
});

requestAnimationFrame(update);
}

function updateWins(){
let list=document.getElementById("winsList");
list.innerHTML="";
Object.entries(wins)
.sort((a,b)=>b[1]-a[1])
.slice(0,10)
.forEach(e=>{
let d=document.createElement("div");
d.className="winItem";
let img=document.createElement("img");
img.src=e[0];
let s=document.createElement("span");
s.innerText=" x "+e[1];
d.appendChild(img);
d.appendChild(s);
list.appendChild(d);
});
}

function reset(){
eliminated=[];
loadFlags();
countdown();
}

loadFlags();
countdown();
update();
</script>
</body>
</html>
