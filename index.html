<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Flag Arena</title>
<style>
body{
  margin:0;
  overflow:hidden;
  background:#0b1220;
  font-family:Arial, sans-serif;
  color:white;
}

canvas{display:block;}

#countdown,#winner{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  font-weight:bold;
  text-align:center;
}

#countdown{top:40%;font-size:80px;}
#winner{top:45%;font-size:48px;display:none;}

#eliminated{
  position:absolute;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  width:80%;
  gap:6px;
}

#topwins{
  position:absolute;
  top:20px;
  right:20px;
  background:rgba(0,0,0,0.6);
  padding:15px;
  border-radius:10px;
  font-size:16px;
}

#topwins h3{
  margin:0 0 10px 0;
  font-size:18px;
  text-align:center;
}

.bg-text{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-size:140px;
  font-weight:900;
  letter-spacing:15px;
  color:rgba(255,255,255,0.04);
  pointer-events:none;
}
</style>
</head>
<body>

<div class="bg-text">FLAG ARENA</div>

<canvas id="arena"></canvas>

<div id="countdown"></div>
<div id="winner"></div>
<div id="eliminated"></div>

<div id="topwins">
  <h3>TOP WINS</h3>
  <div id="toplist"></div>
</div>

<script>

const canvas=document.getElementById("arena");
const ctx=canvas.getContext("2d");

function resize(){
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
}
resize();
window.addEventListener("resize",resize);

function CX(){return canvas.width/2}
function CY(){return canvas.height/2}

let arenaRadius=Math.min(window.innerWidth,window.innerHeight)/3;
let rotation=0;
let gameStarted=false;
let gameOver=false;

const countryCodes=[
"us","tr","de","fr","br","jp","it","gb","ca","ar",
"es","kr","mx","nl","se","no","pt","gr","in","cn",
"ru","au","nz","za","eg","sa","ae","id","pk","ch"
];

let particles=[];
let images={};
let eliminatedList=[];
let wins={};

function preloadImages(callback){
  let loaded=0;
  countryCodes.forEach(code=>{
    const img=new Image();
    img.src="https://flagcdn.com/w40/"+code+".png";
    img.onload=()=>{
      loaded++;
      if(loaded===countryCodes.length){
        callback();
      }
    };
    images[code]=img;
  });
}

function initGame(){
  particles=[];
  eliminatedList=[];
  document.getElementById("eliminated").innerHTML="";
  document.getElementById("winner").style.display="none";
  gameOver=false;
  gameStarted=false;

  countryCodes.forEach(code=>{
    particles.push({
      code:code,
      x:CX()+(Math.random()-0.5)*200,
      y:CY()+(Math.random()-0.5)*200,
      vx:(Math.random()-0.5)*20, // 5x hız
      vy:(Math.random()-0.5)*20,
      r:22
    });
  });

  startCountdown();
}

function startCountdown(){
  let count=10;
  const cd=document.getElementById("countdown");
  cd.innerText=count;

  const interval=setInterval(()=>{
    count--;
    cd.innerText=count;
    if(count<=0){
      clearInterval(interval);
      cd.innerText="";
      gameStarted=true;
    }
  },1000);
}

function drawArena(){
  rotation+=0.07; // daha hızlı dönüyor

  ctx.save();
  ctx.translate(CX(),CY());
  ctx.rotate(rotation);

  ctx.beginPath();
  ctx.arc(0,0,arenaRadius,0.6,Math.PI*2-0.6);
  ctx.strokeStyle="#22d3ee";
  ctx.lineWidth=6;
  ctx.stroke();

  ctx.restore();
}

function updateTopWins(){
  const sorted=Object.entries(wins)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,3);

  const list=document.getElementById("toplist");
  list.innerHTML="";
  sorted.forEach((item,i)=>{
    list.innerHTML+=`${i+1}. ${item[0].toUpperCase()} - ${item[1]}<br>`;
  });
}

function update(){

  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawArena();

  if(!gameStarted){
    requestAnimationFrame(update);
    return;
  }

  if(gameOver){
    requestAnimationFrame(update);
    return;
  }

  for(let i=0;i<particles.length;i++){
    let p=particles[i];

    p.x+=p.vx;
    p.y+=p.vy;

    let dx=p.x-CX();
    let dy=p.y-CY();
    let dist=Math.sqrt(dx*dx+dy*dy);

    if(dist+p.r>arenaRadius){

      let angle=Math.atan2(dy,dx)-rotation;
      while(angle<-Math.PI) angle+=Math.PI*2;
      while(angle>Math.PI) angle-=Math.PI*2;

      if(angle>-0.6 && angle<0.6){
        eliminatedList.push(p.code);
        const img=document.createElement("img");
        img.src=images[p.code].src;
        img.width=24;
        document.getElementById("eliminated").appendChild(img);

        particles.splice(i,1);
        i--;
        continue;
      }

      let nx=dx/dist;
      let ny=dy/dist;
      let dot=p.vx*nx+p.vy*ny;
      p.vx-=2*dot*nx;
      p.vy-=2*dot*ny;
    }

    for(let j=i+1;j<particles.length;j++){
      let p2=particles[j];
      let dx2=p2.x-p.x;
      let dy2=p2.y-p.y;
      let d=Math.sqrt(dx2*dx2+dy2*dy2);

      if(d<p.r+p2.r){
        let nx=dx2/d;
        let ny=dy2/d;
        let pDot=p.vx*nx+p.vy*ny;
        let p2Dot=p2.vx*nx+p2.vy*ny;
        p.vx+=(p2Dot-pDot)*nx;
        p.vy+=(p2Dot-pDot)*ny;
        p2.vx+=(pDot-p2Dot)*nx;
        p2.vy+=(pDot-p2Dot)*ny;
      }
    }

    ctx.drawImage(images[p.code], p.x-p.r, p.y-p.r, p.r*2, p.r*2);
  }

  if(particles.length===1){
    gameOver=true;
    gameStarted=false;

    const winner=particles[0].code;
    wins[winner]=(wins[winner]||0)+1;
    updateTopWins();

    document.getElementById("winner").innerText=
      "WINNER: "+winner.toUpperCase();
    document.getElementById("winner").style.display="block";

    setTimeout(()=>{
      initGame();
    },4000);
  }

  requestAnimationFrame(update);
}

preloadImages(()=>{
  initGame();
  update();
});

</script>
</body>
</html>
