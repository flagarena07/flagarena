<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>FLAG ARENA</title>
<style>
body { margin:0; background:white; overflow:hidden; font-family:Arial; }
canvas { display:block; }

#winsBoard {
    position:absolute;
    top:20px;
    right:20px;
    width:230px;
    font-size:13px;
}
#winsBoard h3 { margin:0 0 10px 0; }

.winItem{
    display:flex;
    align-items:center;
    margin-bottom:4px;
}
.winItem img{
    width:18px;
    height:12px;
    margin-right:6px;
}

#countdown {
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    font-size:80px;
    font-weight:bold;
}

#title {
    position:absolute;
    top:40%;
    left:50%;
    transform:translateX(-50%);
    font-size:50px;
    opacity:0.08;
}
</style>
</head>
<body>

<div id="title">FLAG ARENA</div>
<div id="countdown"></div>

<div id="winsBoard">
    <h3>Top Wins</h3>
    <div id="winsList"></div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const centerX = canvas.width/2;
const centerY = canvas.height/2 - 50;
const arenaRadius = 260;
const wallThickness = 16;
const gapSize = Math.PI / 10;

let gapAngle = 0;
let flags = [];
let eliminated = [];
let wins = {};
let gameActive = false;

/* ~60 ülke */
const countryCodes = [
"tr","us","de","fr","br","jp","it","es","gb","ca",
"ru","cn","in","ar","mx","nl","se","no","fi","pl",
"pt","gr","ch","be","at","dk","kr","au","nz","za",
"sa","ae","ir","iq","eg","cl","co","ve","pe","cz",
"hu","ro","sk","si","hr","bg","ua","kz","th","my",
"id","ph","sg","pk","bd","ng","ke","ma","tn","dz"
];

const flagSources = countryCodes.map(code => 
    `https://flagcdn.com/w80/${code}.png`
);

function loadFlags(){
    flags = [];
    flagSources.forEach(src=>{
        const img = new Image();
        img.src = src;
        flags.push({
            img: img,
            name: src,
            x: centerX + (Math.random()-0.5)*120,
            y: centerY + (Math.random()-0.5)*120,
            vx: (Math.random()-0.5)*3,  // hız ciddi düşürüldü
            vy: (Math.random()-0.5)*3,
            radius: 16
        });
    });
}

function startCountdown(){
    let count=3;
    const cd=document.getElementById("countdown");
    cd.innerText=count;
    const interval=setInterval(()=>{
        count--;
        if(count>=0) cd.innerText=count;
        if(count<0){
            clearInterval(interval);
            cd.innerText="";
            gameActive=true;
        }
    },1000);
}

function circleCollision(a,b){
    const dx=b.x-a.x;
    const dy=b.y-a.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(dist < a.radius+b.radius){
        const angle=Math.atan2(dy,dx);
        const overlap=(a.radius+b.radius - dist)/2;
        const nx=Math.cos(angle);
        const ny=Math.sin(angle);

        a.x -= nx*overlap;
        a.y -= ny*overlap;
        b.x += nx*overlap;
        b.y += ny*overlap;

        const tempVx=a.vx;
        const tempVy=a.vy;
        a.vx=b.vx;
        a.vy=b.vy;
        b.vx=tempVx;
        b.vy=tempVy;
    }
}

function update(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    gapAngle += 0.015;

    // Arena
    ctx.beginPath();
    ctx.arc(centerX, centerY, arenaRadius, 0, Math.PI*2);
    ctx.lineWidth = wallThickness;
    ctx.stroke();

    // Gap görsel
    ctx.beginPath();
    ctx.arc(centerX, centerY, arenaRadius, gapAngle, gapAngle+gapSize);
    ctx.strokeStyle="red";
    ctx.lineWidth=wallThickness+2;
    ctx.stroke();
    ctx.strokeStyle="black";

    if(gameActive){

        for(let i=0;i<flags.length;i++){
            for(let j=i+1;j<flags.length;j++){
                circleCollision(flags[i],flags[j]);
            }
        }

        flags.forEach(f=>{
            f.x+=f.vx;
            f.y+=f.vy;

            const dx=f.x-centerX;
            const dy=f.y-centerY;
            const dist=Math.sqrt(dx*dx+dy*dy);

            const innerLimit = arenaRadius - wallThickness/2;

            if(dist + f.radius > innerLimit){

                const angle=Math.atan2(dy,dx);
                let diff=angle-gapAngle;
                diff=(diff+Math.PI*2)%(Math.PI*2);

                const nx=dx/dist;
                const ny=dy/dist;

                // Kapıdan çıkma şartı:
                // 1) Açı gap içinde olacak
                // 2) Bayrak dışa doğru hareket ediyor olacak (dot > 0)
                const dot = f.vx*nx + f.vy*ny;

                if(diff < gapSize && dot > 0){
                    eliminated.push(f);
                } else {
                    // Duvar sekmesi
                    f.vx -= 2*dot*nx;
                    f.vy -= 2*dot*ny;

                    f.x = centerX + nx*(innerLimit - f.radius);
                    f.y = centerY + ny*(innerLimit - f.radius);
                }
            }
        });

        flags=flags.filter(f=>!eliminated.includes(f));

        if(flags.length===1){
            const winner=flags[0];
            wins[winner.name]=(wins[winner.name]||0)+1;
            updateWins();
            gameActive=false;
            setTimeout(resetGame,2500);
        }
    }

    flags.forEach(f=>{
        ctx.drawImage(f.img,f.x-f.radius,f.y-f.radius,f.radius*2,f.radius*2);
    });

    drawEliminated();
    requestAnimationFrame(update);
}

function drawEliminated(){
    const startY=canvas.height-70;
    eliminated.forEach((f,i)=>{
        ctx.drawImage(f.img,20+i*25,startY,20,14);
    });
}

function updateWins(){
    const list=document.getElementById("winsList");
    list.innerHTML="";
    const sorted=Object.entries(wins)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,10);

    sorted.forEach(entry=>{
        const div=document.createElement("div");
        div.className="winItem";

        const img=document.createElement("img");
        img.src=entry[0];

        const span=document.createElement("span");
        span.innerText=" x "+entry[1];

        div.appendChild(img);
        div.appendChild(span);
        list.appendChild(div);
    });
}

function resetGame(){
    eliminated=[];
    loadFlags();
    startCountdown();
}

loadFlags();
startCountdown();
update();
</script>

</body>
</html>
