<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Flag Arena</title>
<style>
body{
  margin:0;
  overflow:hidden;
  background:#0f172a;
  font-family:Arial;
  color:white;
}
canvas{
  display:block;
}
#countdown, #winner{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  font-weight:bold;
  text-align:center;
}
#countdown{
  top:40%;
  font-size:80px;
}
#winner{
  top:45%;
  font-size:50px;
  display:none;
}
</style>
</head>
<body>

<canvas id="arena"></canvas>
<div id="countdown"></div>
<div id="winner"></div>

<script>

const canvas=document.getElementById("arena");
const ctx=canvas.getContext("2d");

function resize(){
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
}
resize();
window.addEventListener("resize",resize);

function CX(){ return canvas.width/2 }
function CY(){ return canvas.height/2 }

let arenaRadius=Math.min(window.innerWidth,window.innerHeight)/3;
let rotation=0;
let gameStarted=false;
let gameOver=false;

const countryCodes=[
"us","tr","de","fr","br","jp","it","gb","ca","ar",
"es","kr","mx","nl","se","no","pt","gr","in","cn",
"ru","au","nz","za","eg","sa","ae","id","pk","ch"
];

let particles=[];
let images={};

function preloadImages(callback){
  let loaded=0;
  countryCodes.forEach(code=>{
    const img=new Image();
    img.src="https://flagcdn.com/w40/"+code+".png";
    img.onload=()=>{
      loaded++;
      if(loaded===countryCodes.length){
        callback();
      }
    };
    images[code]=img;
  });
}

function initGame(){
  particles=[];
  gameOver=false;
  document.getElementById("winner").style.display="none";

  countryCodes.forEach(code=>{
    particles.push({
      code:code,
      x:CX()+(Math.random()-0.5)*200,
      y:CY()+(Math.random()-0.5)*200,
      vx:(Math.random()-0.5)*8,
      vy:(Math.random()-0.5)*8,
      r:20
    });
  });

  startCountdown();
}

function startCountdown(){
  let count=10;
  const cd=document.getElementById("countdown");
  cd.innerText=count;

  const interval=setInterval(()=>{
    count--;
    cd.innerText=count;
    if(count<=0){
      clearInterval(interval);
      cd.innerText="";
      gameStarted=true;
    }
  },1000);
}

function drawArena(){
  rotation+=0.025;

  ctx.save();
  ctx.translate(CX(),CY());
  ctx.rotate(rotation);

  ctx.beginPath();
  ctx.arc(0,0,arenaRadius,0.7,Math.PI*2-0.7);
  ctx.strokeStyle="#22d3ee";
  ctx.lineWidth=6;
  ctx.stroke();

  ctx.restore();
}

function update(){

  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawArena();

  if(!gameStarted){
    requestAnimationFrame(update);
    return;
  }

  if(gameOver){
    requestAnimationFrame(update);
    return;
  }

  for(let i=0;i<particles.length;i++){
    let p=particles[i];

    p.x+=p.vx;
    p.y+=p.vy;

    let dx=p.x-CX();
    let dy=p.y-CY();
    let dist=Math.sqrt(dx*dx+dy*dy);

    if(dist+p.r>arenaRadius){

      let angle=Math.atan2(dy,dx)-rotation;
      while(angle<-Math.PI) angle+=Math.PI*2;
      while(angle>Math.PI) angle-=Math.PI*2;

      if(angle>-0.7 && angle<0.7){
        particles.splice(i,1);
        i--;
        continue;
      }

      let nx=dx/dist;
      let ny=dy/dist;
      let dot=p.vx*nx+p.vy*ny;
      p.vx-=2*dot*nx;
      p.vy-=2*dot*ny;
    }

    for(let j=i+1;j<particles.length;j++){
      let p2=particles[j];
      let dx2=p2.x-p.x;
      let dy2=p2.y-p.y;
      let d=Math.sqrt(dx2*dx2+dy2*dy2);

      if(d<p.r+p2.r){
        let nx=dx2/d;
        let ny=dy2/d;
        let pDot=p.vx*nx+p.vy*ny;
        let p2Dot=p2.vx*nx+p2.vy*ny;
        p.vx+=(p2Dot-pDot)*nx;
        p.vy+=(p2Dot-pDot)*ny;
        p2.vx+=(pDot-p2Dot)*nx;
        p2.vy+=(pDot-p2Dot)*ny;
      }
    }

    ctx.drawImage(images[p.code], p.x-p.r, p.y-p.r, p.r*2, p.r*2);
  }

  if(particles.length===1){
    gameOver=true;
    gameStarted=false;

    document.getElementById("winner").innerText=
      "WINNER: "+particles[0].code.toUpperCase();
    document.getElementById("winner").style.display="block";

    setTimeout(()=>{
      initGame();
    },4000);
  }

  requestAnimationFrame(update);
}

preloadImages(()=>{
  initGame();
  update();
});

</script>
</body>
</html>
